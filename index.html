<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>네오 스피드: 레전드 - v0.0.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* Nitro Bar */
        .nitro-bar-container { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 350px; height: 14px; background: rgba(255,255,255,0.1); border-radius: 7px; overflow: hidden; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(5px); }
        #nitro-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #ffd700, #ff4500); transition: width 0.1s linear; position: relative; }
        #nitro-bar.shockwave { background: linear-gradient(90deg, #bf00ff, #ff007f); box-shadow: 0 0 20px #bf00ff; }

        /* Speedometer */
        #speedometer { position: absolute; bottom: 40px; right: 40px; color: #fff; text-align: right; }
        #speed-value { font-size: 64px; font-weight: 900; font-style: italic; line-height: 1; color: #00ffff; }
        
        /* Messages */
        #message-box { position: absolute; top: 120px; left: 50%; transform: translateX(-50%); color: #fff; font-size: 32px; font-weight: 900; opacity: 0; transition: transform 0.3s, opacity 0.3s; text-shadow: 0 0 20px rgba(255,255,255,0.8); font-style: italic; }
        
        .controls-guide { position: absolute; bottom: 40px; left: 40px; color: rgba(255,255,255,0.5); font-size: 13px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="nitro-bar-container">
            <div id="nitro-bar"></div>
        </div>
        <div id="message-box">ACTION!</div>
        <div id="speedometer">
            <div id="speed-value">0</div>
            <div class="font-bold tracking-widest text-cyan-400">KM/H</div>
        </div>
        <div class="controls-guide">
            <span class="text-white font-bold">W / ↑</span> 가속 &nbsp; <span class="text-white font-bold">A, D / ←, →</span> 조향<br>
            <span class="text-white font-bold">S 2회 연타</span> 지상/공중 360도 회전<br>
            <span class="text-white font-bold">배럴롤 점프대(보라색)</span> 자동 배럴롤 발동<br>
            <span class="text-white font-bold">Space</span> 니트로 (쇼크웨이브 포함)
        </div>
    </div>

    <script>
        let scene, camera, renderer, car, clock;
        let speed = 0, velocityY = 0;
        const gravity = -0.008;
        const maxSpeed = 1.3;
        const acceleration = 0.006;
        const friction = 0.985;
        
        let nitroAmount = 30;
        let isNitroActive = false, isShockwave = false;
        let isSpinning = false, isBarrelRolling = false;
        let spinAngle = 0, barrelRollAngle = 0;
        
        const ramps = [];
        const keys = {};
        let lastSKeyTime = 0;

        const RAMP_TYPE = { NORMAL: 'normal', BARREL: 'barrel' };

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x020205);
            scene.fog = new THREE.Fog(0x020205, 20, 150);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0x404040, 1.5));
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(5, 15, 10);
            scene.add(sun);

            createEnvironment();
            createCar();
            createRamps();

            clock = new THREE.Clock();
            
            window.addEventListener('keydown', (e) => {
                keys[e.code] = true;
                if (e.code === 'KeyS') {
                    const now = Date.now();
                    if (now - lastSKeyTime < 300 && !isSpinning) {
                        start360Spin(); // Always 360 on S double tap
                    }
                    lastSKeyTime = now;
                }
                if (e.code === 'Space' && nitroAmount > 10 && !isNitroActive) activateNitro();
            });
            window.addEventListener('keyup', (e) => keys[e.code] = false);
            window.addEventListener('resize', onWindowResize);

            animate();
        }

        function createEnvironment() {
            const roadGeo = new THREE.PlaneGeometry(24, 10000);
            const roadMat = new THREE.MeshStandardMaterial({ color: 0x111111 });
            const road = new THREE.Mesh(roadGeo, roadMat);
            road.rotation.x = -Math.PI / 2;
            scene.add(road);

            // Side lines
            for(let i=0; i<2; i++) {
                const curb = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.2, 10000), new THREE.MeshBasicMaterial({ color: 0x00ffff }));
                curb.position.set(i === 0 ? -12 : 12, 0.1, 5000);
                scene.add(curb);
            }
        }

        function createCar() {
            car = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(1.4, 0.6, 2.8), new THREE.MeshStandardMaterial({ color: 0xff2200, metalness: 0.8 }));
            body.position.y = 0.5;
            car.add(body);
            
            const cabin = new THREE.Mesh(new THREE.BoxGeometry(1.1, 0.4, 1.2), new THREE.MeshStandardMaterial({ color: 0x000000 }));
            cabin.position.set(0, 0.8, 0.2);
            car.add(cabin);

            scene.add(car);
        }

        function createRamps() {
            for (let i = 1; i <= 20; i++) {
                const isBarrel = i % 3 === 0;
                const z = i * 350;
                const x = (Math.random() - 0.5) * 12;
                
                const rGeo = new THREE.BoxGeometry(6, 0.5, 10);
                const rMat = new THREE.MeshStandardMaterial({ color: isBarrel ? 0xbf00ff : 0xffcc00 });
                const ramp = new THREE.Mesh(rGeo, rMat);
                
                ramp.rotation.x = -0.25;
                if (isBarrel) {
                    ramp.rotation.z = (x > 0) ? -0.4 : 0.4; // Tilted for barrel roll
                }
                
                ramp.position.set(x, 0.8, z);
                scene.add(ramp);
                ramps.push({ mesh: ramp, x, z, type: isBarrel ? RAMP_TYPE.BARREL : RAMP_TYPE.NORMAL });
            }
        }

        function start360Spin() {
            isSpinning = true;
            spinAngle = 0;
            nitroAmount = Math.min(100, nitroAmount + 15);
            showMessage("360 SPIN!");
        }

        function activateNitro() {
            isNitroActive = true;
            if (nitroAmount >= 98) {
                isShockwave = true;
                showMessage("SHOCKWAVE!!!");
                document.getElementById('nitro-bar').classList.add('shockwave');
            } else {
                showMessage("NITRO BOOST");
            }
        }

        function showMessage(txt) {
            const msg = document.getElementById('message-box');
            msg.innerText = txt;
            msg.style.opacity = 1;
            msg.style.transform = 'translateX(-50%) scale(1.3)';
            setTimeout(() => {
                msg.style.opacity = 0;
                msg.style.transform = 'translateX(-50%) scale(1)';
            }, 1000);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();

            // Physics
            if (keys['ArrowUp'] || keys['KeyW']) speed += acceleration;
            else speed *= friction;

            // Nitro
            if (isNitroActive) {
                nitroAmount -= isShockwave ? 0.7 : 0.35;
                speed += isShockwave ? 0.025 : 0.012;
                if (nitroAmount <= 0) {
                    isNitroActive = false; isShockwave = false;
                    document.getElementById('nitro-bar').classList.remove('shockwave');
                }
            } else if (speed > 0.1) {
                nitroAmount = Math.min(100, nitroAmount + 0.05);
            }

            speed = Math.min(speed, isShockwave ? maxSpeed * 1.6 : maxSpeed);
            car.position.z += speed;

            // Steering
            if (speed > 0.1 && !isSpinning) {
                if (keys['ArrowLeft'] || keys['KeyA']) car.position.x += 0.2;
                if (keys['ArrowRight'] || keys['KeyD']) car.position.x -= 0.2;
            }
            car.position.x = THREE.MathUtils.clamp(car.position.x, -11, 11);

            // Vertical & Jump
            car.position.y += velocityY;
            if (car.position.y > 0) {
                velocityY += gravity;
                nitroAmount += 0.1;
            } else {
                car.position.y = 0; velocityY = 0;
                if (isBarrelRolling) {
                    isBarrelRolling = false;
                    car.rotation.z = 0;
                }
            }

            // Ramp Collision
            ramps.forEach(ramp => {
                const dz = Math.abs(car.position.z - ramp.z);
                const dx = Math.abs(car.position.x - ramp.x);
                if (dz < 5 && dx < 3 && car.position.y < 1.5 && velocityY <= 0) {
                    velocityY = 0.25 + (speed * 0.12);
                    if (ramp.type === RAMP_TYPE.BARREL && !isBarrelRolling) {
                        isBarrelRolling = true;
                        barrelRollAngle = 0;
                        nitroAmount = Math.min(100, nitroAmount + 25);
                        showMessage("BARREL ROLL!!");
                    } else if (ramp.type === RAMP_TYPE.NORMAL) {
                        showMessage("JUMP!");
                    }
                }
            });

            // Rotations
            if (isSpinning) {
                spinAngle += 0.3;
                car.rotation.y += 0.3;
                if (spinAngle >= Math.PI * 2) {
                    isSpinning = false;
                    car.rotation.y = 0;
                }
            } else {
                // Lean into turns
                const lean = (keys['ArrowLeft'] || keys['KeyA']) ? 0.2 : (keys['ArrowRight'] || keys['KeyD'] ? -0.2 : 0);
                car.rotation.y = THREE.MathUtils.lerp(car.rotation.y, lean, 0.1);
            }

            if (isBarrelRolling) {
                barrelRollAngle += 0.15;
                car.rotation.z += 0.15;
                // Auto-straighten if nearly finished and close to ground
                if (barrelRollAngle > Math.PI * 2 && car.position.y < 1) {
                    isBarrelRolling = false;
                    car.rotation.z = 0;
                }
            }

            // Camera
            const camTarget = new THREE.Vector3(car.position.x * 0.5, car.position.y + 3, car.position.z - 8 - (speed * 2));
            camera.position.lerp(camTarget, 0.1);
            camera.lookAt(car.position.x, car.position.y + 1, car.position.z + 20);

            // UI
            document.getElementById('speed-value').innerText = Math.floor(speed * 340);
            document.getElementById('nitro-bar').style.width = nitroAmount + '%';

            renderer.render(scene, camera);
        }

        window.onload = init;
    </script>
</body>
</html>
