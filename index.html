<!DOCTYPE html>
<html lang="ko" data-theme="system">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>아스팔트 레전드 우회결제 계산기</title>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #0f172a; /* slate-900 */
      --muted: #6b7280; /* gray-500 */
      --card: #f8fafc; /* slate-50 */
      --border: #e5e7eb; /* gray-200 */
      --accent: #3b82f6; /* blue-500 */
      --accent-fg: #ffffff;
      --danger: #ef4444; /* red-500 */
      --success: #10b981; /* emerald-500 */
    }
    [data-theme="dark"] {
      --bg: #0b1020;
      --fg: #e5e7eb;
      --muted: #9aa1ad;
      --card: #0f172a;
      --border: #1f2937;
      --accent: #60a5fa;
      --accent-fg: #0b1020;
      --danger: #f87171;
      --success: #34d399;
    }
    /* === Extra Themes === */
    [data-theme="onyx"]{
      --bg: linear-gradient(135deg, #0b0b0b, #1a1a1a);
      --fg:#e0e0e0; --muted:#8a8a8a; --card:#121212; --border:#1f1f1f;
      --accent:#3a8ef6; --accent-fg:#000;
    }
    [data-theme="chroma-glow"]{
      --bg: linear-gradient(120deg, #000000, #1b0034 40%, #002f4b 80%);
      --fg:#f4f4f4; --muted:#9d9d9d; --card:#090909; --border:#1a1a1a;
      --accent: linear-gradient(90deg, #ff00cc, #3333ff); --accent-fg:#ffffff;
    }
    [data-theme="sunset"]{
      --bg: linear-gradient(160deg, #ff9966, #ff5e62);
      --fg:#fff8f0; --muted:#ffe0c7; --card: rgba(255,255,255,0.08); --border:#ffffff22;
      --accent:#ffd700; --accent-fg:#703300;
    }
    [data-theme="forest"]{
      --bg: linear-gradient(180deg, #0a3d2e, #062a1f);
      --fg:#d8f3dc; --muted:#a9d6c6; --card:#0d2f22; --border:#1a3a2c;
      --accent:#52b788; --accent-fg:#0a3d2e;
    }
    [data-theme="crimson-moon"]{
      --bg: linear-gradient(145deg, #1b0a0f, #3a0b14);
      --fg:#f8d7da; --muted:#b89a9c; --card:#2b1018; --border:#4a1a24;
      --accent:#ff4d6d; --accent-fg:#220006;
    }
    [data-theme="midnight-blueviolet"]{
      --bg: linear-gradient(135deg, #0f172a, #1e1b4b, #312e81);
      --fg:#e0e7ff; --muted:#a5b4fc; --card:#1e1b4b; --border:#2a2c5a;
      --accent:#818cf8; --accent-fg:#0f172a;
    }
    [data-theme="neon-night"]{
      --bg:#05010f;
      --fg:#e6e6fa; --muted:#9a9abd; --card: linear-gradient(135deg, #0b0019, #12002b); --border:#2a1149;
      --accent: linear-gradient(90deg, #00ffff, #ff00ff); --accent-fg:#000;
    }
    [data-theme="aurora"]{
      --bg: linear-gradient(160deg, #0b0033, #004f4f 40%, #001a33 90%);
      --fg:#e0f7fa; --muted:#a7cbd1; --card: rgba(255,255,255,0.05); --border:#58a6aa44;
      --accent: linear-gradient(90deg, #00ffff, #00ff87, #00ffa2); --accent-fg:#001818;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--fg);
    }
    .container { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; }
    .title { font-weight: 800; font-size: 22px; margin: 0 0 8px; }
    .subtitle { color: var(--muted); font-size: 14px; margin-bottom: 12px; }
    label { font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px; }
    input[type="number"], input[type="text"], select { width: 100%; padding: 10px 12px; background: var(--bg); color: var(--fg); border: 1px solid var(--border); border-radius: 12px; outline: none; }
    input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .inline { display: flex; gap: 8px; align-items: center; }
    .btn { cursor: pointer; border: 1px solid var(--border); background: var(--bg); color: var(--fg); border-radius: 12px; padding: 10px 14px; font-weight: 700; }
    .btn:hover { border-color: var(--accent); }
    .btn.primary { background: var(--accent); color: var(--accent-fg); border-color: var(--accent); }
    .btn.ghost { background: transparent; }
    .btn.small { padding: 6px 10px; font-weight: 600; }
    .chip { display:inline-flex; align-items:center; gap:6px; background: var(--bg); border:1px solid var(--border); padding:6px 10px; border-radius:999px; color:var(--muted); font-size:12px; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .grid-3 { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    .pack { display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; }
    .pack input { text-align: right; font-variant-numeric: tabular-nums; }
    .stat { display:flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed var(--border); font-variant-numeric: tabular-nums; }
    .stat:last-child { border-bottom: 0; }
    .muted { color: var(--muted); }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, monospace; font-size: 12px; background: var(--bg); border:1px solid var(--border); border-radius:6px; padding:2px 6px; }
    .section-title { font-weight: 800; margin: 8px 0 6px; font-size: 16px; }
    hr { border: 0; height: 1px; background: var(--border); margin: 12px 0; }
    .list { display:flex; flex-direction: column; gap:8px; }
    .history-item { display:flex; justify-content: space-between; gap:12px; align-items:center; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:var(--bg); }
    .tag { background: var(--card); border:1px solid var(--border); color: var(--muted); font-size:12px; padding:2px 8px; border-radius:999px; }
    .danger { color: var(--danger); }
    .success { color: var(--success); }
    .spacer { height: 4px; }
    .dev { font-size:12px; color:var(--muted); }
  </style>
</head>
<body>
  <div class="container">
    <div class="row">
      <!-- Header Card -->
      <div class="card" style="grid-column: span 12; display:flex; justify-content: space-between; align-items: center; gap:12px; flex-wrap: wrap;">
        <div>
          <div class="title">Asphalt Legends 결제 계산기 — Preset · History · Share</div>
          <div class="subtitle">프리셋 저장/불러오기, 최근 5회 히스토리, 요약 복사(텍스트/Markdown/Discord), 테마(라이트/다크/시스템) 지원</div>
        </div>
        <div class="inline" role="group" aria-label="Theme">
          <label for="themeSelect" class="muted" style="font-size:13px;">테마</label>
          <select id="themeSelect">
            <option value="system">시스템</option>
            <option value="light">라이트</option>
            <option value="dark">어두운 테마</option>
            <option value="onyx">오닉스</option>
            <option value="chroma-glow">크로마 그로우</option>
            <option value="sunset">일몰</option>
            <option value="forest">숲</option>
            <option value="crimson-moon">진홍빛 달</option>
            <option value="midnight-blueviolet">한밤중 파랑보라</option>
            <option value="neon-night">네온 나이트</option>
            <option value="aurora">오로라</option>
          </select>
        </div>
      </div>

      <!-- Input Card -->
      <div class="card" style="grid-column: span 8;">
        <div class="section-title">입력</div>
        <div class="grid-3" id="packs"><!-- Packs will be injected --></div>
        <div class="spacer"></div>
        <div class="grid-3">
          <div>
            <label for="extraARS">추가 금액(ARS)</label>
            <input id="extraARS" type="number" min="0" value="0" />
          </div>
          <div>
            <label for="rate">환율 (1 ARS → KRW)</label>
            <input id="rate" type="number" step="0.001" min="0" value="4" />
          </div>
          <div>
            <label for="note">메모(선택)</label>
            <input id="note" type="text" placeholder="예: 블프 프로모션 세팅" />
          </div>
        </div>
        <div class="spacer"></div>
        <div class="inline">
          <button class="btn primary" id="btnCalc">계산하기</button>
          <button class="btn" id="btnClear">초기화</button>
          <span id="calcStatus" class="chip">대기 중</span>
        </div>
      </div>

      <!-- Result Card -->
      <div class="card" style="grid-column: span 4;">
        <div class="section-title">결과</div>
        <div id="results">
          <div class="stat"><span>총합(ARS)</span><strong id="sumARS">0</strong></div>
          <div class="stat"><span>환산(KRW)</span><strong id="sumKRW">₩0</strong></div>
        </div>
        <div class="subtitle" id="feeNote">* 계산식: (총합 ARS × 환율) + 고정수수료 <strong>₩1,000</strong> 포함</div>
        <hr />
        <label for="formatSelect">요약 복사 포맷</label>
        <div class="inline">
          <select id="formatSelect">
            <option value="text">텍스트</option>
            <option value="md">Markdown</option>
            <option value="discord">Discord</option>
          </select>
          <button class="btn" id="btnCopy">요약 복사</button>
        </div>
        <div id="copyStatus" class="subtitle" style="margin-top:8px;"></div>
      </div>

      <!-- Preset Card -->
      <div class="card" style="grid-column: span 6;">
        <div class="section-title">프리셋</div>
        <div class="grid-2">
          <div>
            <label for="presetName">프리셋 이름</label>
            <input id="presetName" type="text" placeholder="예: 월정액 기본" />
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="inline">
              <button class="btn" id="btnSavePreset">프리셋 저장</button>
              <button class="btn danger" id="btnDeletePreset">삭제</button>
            </div>
          </div>
        </div>
        <div class="spacer"></div>
        <label for="presetSelect">프리셋 불러오기</label>
        <div class="inline">
          <select id="presetSelect"></select>
          <button class="btn" id="btnLoadPreset">불러오기</button>
        </div>
        <div id="presetStatus" class="subtitle" style="margin-top:8px;"></div>
      </div>

      <!-- History Card -->
      <div class="card" style="grid-column: span 6;">
        <div class="section-title">히스토리 (최근 5회)</div>
        <div class="list" id="historyList"></div>
        <div class="inline" style="margin-top:8px;">
          <button class="btn ghost danger" id="btnClearHistory">히스토리 비우기</button>
        </div>
      </div>

      <!-- Remote Preset Card -->
      <div class="card" style="grid-column: span 12;">
        <div class="section-title">원격 프리셋 가져오기 (선택)</div>
        <div class="grid-2">
          <div>
            <label for="remoteUrl">프리셋이 있는 페이지 URL</label>
            <input id="remoteUrl" type="text" placeholder="예: https://steampasswordstolez.github.io/AsphaltLegendsMultong/" />
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="inline">
              <button class="btn" id="btnFetchRemote">가져오기</button>
              <span class="subtitle" id="remoteStatus"></span>
            </div>
          </div>
        </div>
        <div class="subtitle">설명: 드롭다운의 옵션 텍스트(프리셋 이름)를 읽어와 프리셋 목록에 추가합니다. (동일 이름은 건너뜀)</div>
      </div>

      <!-- Test Card -->
      <div class="card" style="grid-column: span 12;">
        <div class="section-title">개발자 도구 · 테스트</div>
        <div class="inline">
          <button class="btn" id="btnRunTests">테스트 실행</button>
          <span id="testStatus" class="dev">대기 중</span>
        </div>
        <div class="dev">콘솔(DevTools)을 열면 상세 결과를 볼 수 있습니다.</div>
      </div>

    </div>
  </div>

  <script>
    // ==== Constants =====
    const PACKS = [29, 70, 142, 284, 714, 1429];
    const LS_KEYS = {
      PRESETS: 'al_calc_presets',
      HISTORY: 'al_calc_history',
      THEME: 'al_calc_theme'
    };

    // ==== Utilities =====
    const fmtARS = (n) => new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(n);
    const fmtKRW = (n) => new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW', maximumFractionDigits: 0 }).format(n);
    const nowStr = () => new Date().toLocaleString('ko-KR');

    function readCounts() {
      const counts = {};
      PACKS.forEach(v => {
        counts[v] = parseInt(document.getElementById('pack-' + v).value || '0', 10);
      });
      return counts;
    }

    function applyCounts(counts) {
      PACKS.forEach(v => {
        document.getElementById('pack-' + v).value = counts[v] ?? 0;
      });
    }

    function sumARS(counts, extra) {
      let total = 0;
      PACKS.forEach(v => total += v * (counts[v] || 0));
      total += extra;
      return Math.max(0, Math.round(total));
    }

    function toSummaryObj() {
      const counts = readCounts();
      const extra = Number(document.getElementById('extraARS').value || 0);
      const rate = Number(document.getElementById('rate').value || 0);
      const totalARS = sumARS(counts, extra);
      const totalKRW = Math.round(totalARS * rate + 1000); // +1000원 고정 수수료 포함
      return { counts, extra, rate, totalARS, totalKRW, note: document.getElementById('note').value || '' };
    }

    function renderTotals(obj) {
      document.getElementById('sumARS').textContent = fmtARS(obj.totalARS) + ' ARS';
      document.getElementById('sumKRW').textContent = fmtKRW(obj.totalKRW);
    }

    function setStatus(id, text, ok=true) {
      const el = document.getElementById(id);
      el.textContent = text;
      el.style.color = ok ? 'var(--success)' : 'var(--danger)';
    }

    // ==== Packs UI build =====
    (function buildPacks(){
      const root = document.getElementById('packs');
      PACKS.forEach(v => {
        const wrap = document.createElement('div');
        wrap.className = 'pack';
        const left = document.createElement('div');
        left.innerHTML = `<label>팩 ${v} ARS</label>`;
        const rightWrap = document.createElement('div');
        rightWrap.className = 'inline';
        const minus = document.createElement('button'); minus.className = 'btn small'; minus.textContent = '−';
        const input = document.createElement('input'); input.type = 'number'; input.min = '0'; input.value = '0'; input.id = 'pack-' + v;
        const plus = document.createElement('button'); plus.className = 'btn small'; plus.textContent = '+';
        minus.addEventListener('click', () => { input.value = Math.max(0, (parseInt(input.value||'0',10)-1)); autoCalc(); });
        plus.addEventListener('click', () => { input.value = Math.max(0, (parseInt(input.value||'0',10)+1)); autoCalc(); });
        input.addEventListener('input', autoCalc);
        rightWrap.append(minus, input, plus);
        wrap.append(left, rightWrap);
        root.appendChild(wrap);
      });
    })();

    // ==== Calculation & History =====
    function calculate() {
      const obj = toSummaryObj();
      renderTotals(obj);
      setStatus('calcStatus', '계산 완료 • ' + nowStr());
      pushHistory(obj);
      renderHistory();
      return obj;
    }

    function autoCalc(){
      const obj = toSummaryObj();
      renderTotals(obj);
      setStatus('calcStatus', '자동 계산 • 임시 (히스토리 저장 안 됨)', true);
    }

    function pushHistory(obj){
      const arr = JSON.parse(localStorage.getItem(LS_KEYS.HISTORY) || '[]');
      arr.unshift({ ...obj, ts: Date.now() });
      const trimmed = arr.slice(0,5);
      localStorage.setItem(LS_KEYS.HISTORY, JSON.stringify(trimmed));
    }

    function renderHistory(){
      const root = document.getElementById('historyList');
      root.innerHTML = '';
      const arr = JSON.parse(localStorage.getItem(LS_KEYS.HISTORY) || '[]');
      if(arr.length===0){
        const empty = document.createElement('div');
        empty.className = 'subtitle';
        empty.textContent = '아직 히스토리가 없습니다.';
        root.appendChild(empty);
        return;
      }
      arr.forEach((h) => {
        const row = document.createElement('div');
        row.className = 'history-item';
        const left = document.createElement('div');
        const parts = [`${new Date(h.ts).toLocaleString('ko-KR')}`];
        if(h.note) parts.push(`메모: ${h.note}`);
        left.innerHTML = `<div><strong>₳ ${fmtARS(h.totalARS)}</strong> → <strong>${fmtKRW(h.totalKRW)}</strong></div>
                          <div class="muted">${parts.join(' • ')}</div>`;
        const btns = document.createElement('div');
        const load = document.createElement('button'); load.className = 'btn small'; load.textContent = '불러오기';
        load.addEventListener('click', ()=>{ applyCounts(h.counts); document.getElementById('extraARS').value = h.extra; document.getElementById('rate').value = h.rate; document.getElementById('note').value = h.note || ''; calculate(); });
        btns.appendChild(load);
        row.append(left, btns);
        root.appendChild(row);
      });
    }

    // ==== Presets =====
    function getPresets(){ return JSON.parse(localStorage.getItem(LS_KEYS.PRESETS) || '{}'); }
    function savePresets(obj){ localStorage.setItem(LS_KEYS.PRESETS, JSON.stringify(obj)); }

    // 기본 프리셋 시드(요청: Infiniti Black S, NIO EP9, BMW i8 등)
    function seedDefaultPresets(){
      const seed = {
  "Infiniti Project Black S 쇼룸": { counts:{29:1,70:2,142:6,284:0,714:0,1429:0}, extra:0, rate:4, note:"기본 쇼룸" },
  "NIO EP9 쇼룸": { counts:{29:5,70:1,142:13,284:8,714:0,1429:0}, extra:0, rate:4, note:"기본 쇼룸" },
  "BMW i8 쇼룸": { counts:{29:1,70:7,142:6,284:5,714:0,1429:0}, extra:0, rate:4, note:"기본 쇼룸" },
  "Renault Sport R.S.01 쇼룸": { counts:{29:1,70:1,142:2,284:7,714:0,1429:0}, extra:0, rate:4, note:"기본 쇼룸" },
  "Lotus Emira 쇼룸": { counts:{29:1,70:4,142:7,284:8,714:0,1429:0}, extra:0, rate:4, note:"기본 쇼룸" },
  "Lamborghini Miura 쇼룸": { counts:{29:1,70:0,142:2,284:5,714:3,1429:0}, extra:0, rate:4, note:"기본 쇼룸" },
  "Honda Civic Type-R 쇼룸": { counts:{29:1,70:2,142:4,284:7,714:0,1429:0}, extra:0, rate:4, note:"기본 쇼룸" },
  "Renault Dezir 쇼룸": { counts:{29:3,70:8,142:6,284:0,714:0,1429:0}, extra:0, rate:4, note:"기본 쇼룸" },
  "Renault TreZor 쇼룸": { counts:{29:1,70:4,142:7,284:5,714:0,1429:0}, extra:0, rate:4, note:"기본 쇼룸" },
  "Ferrari Monza SP1 쇼룸": { counts:{29:1,70:3,142:5,284:8,714:0,1429:0}, extra:0, rate:4, note:"기본 쇼룸" },
  "Volkswagen W12 쇼룸": { counts:{29:1,70:0,142:0,284:5,714:2,1429:3}, extra:0, rate:4, note:"기본 쇼룸" },
  "Lamborghini Sian FKP 37 쇼룸": { counts:{29:1,70:0,142:0,284:10,714:7,1429:11}, extra:0, rate:4, note:"기본 쇼룸" },
  "Boxwell MK X 500 쇼룸": { counts:{29:1,70:5,142:5,284:6,714:0,1429:0}, extra:0, rate:4, note:"기본 쇼룸" },
  "Aston Martin V12 Speedstar 쇼룸": { counts:{29:2,70:3,142:6,284:5,714:0,1429:0}, extra:0, rate:4, note:"기본 쇼룸" },
  "Saleen S1 쇼룸": { counts:{29:3,70:4,142:6,284:10,714:0,1429:0}, extra:0, rate:4, note:"기본 쇼룸" },
  "Vanda Dendrobium 쇼룸": { counts:{29:7,70:2,142:19,284:13,714:0,1429:0}, extra:0, rate:4, note:"기본 쇼룸" }
};
      const existing = getPresets();
      const merged = { ...seed, ...existing }; // 기존이 우선
      savePresets(merged);
    }

    // 원격 페이지에서 프리셋 이름을 추출하여 추가
    async function fetchRemotePresets(url){
      const res = await fetch(url, { mode: 'cors' });
      const html = await res.text();
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const options = Array.from(doc.querySelectorAll('option'))
        .map(o=>o.textContent.trim())
        .filter(t=>t && !/프리셋 선택/i.test(t));
      if(options.length===0) return { added:0, names:[] };
      const presets = getPresets();
      let added = 0; const names = [];
      options.forEach(name=>{
        if(!(name in presets)){
          presets[name] = { counts:{29:0,70:0,142:0,284:0,714:0,1429:0}, extra:0, rate:Number(document.getElementById('rate').value||4), note:'원격에서 추가' };
          added++; names.push(name);
        }
      });
      savePresets(presets);
      refreshPresetSelect();
      return { added, names };
    }

    function refreshPresetSelect(){
      const sel = document.getElementById('presetSelect');
      sel.innerHTML = '';
      const presets = getPresets();
      const names = Object.keys(presets);
      if(names.length===0){
        const opt = document.createElement('option');
        opt.textContent = '프리셋 없음';
        opt.value = '';
        sel.appendChild(opt);
        return;
      }
      names.forEach(n => {
        const opt = document.createElement('option');
        opt.value = n; opt.textContent = n;
        sel.appendChild(opt);
      });
    }

    // ==== Preset Button Wiring =====
    document.getElementById('btnSavePreset').addEventListener('click', ()=>{
      const name = (document.getElementById('presetName').value || '').trim();
      if(!name){ setStatus('presetStatus','프리셋 이름을 입력하세요.', false); return; }
      const obj = toSummaryObj();
      const presets = getPresets();
      presets[name] = obj;
      savePresets(presets);
      refreshPresetSelect();
      setStatus('presetStatus',`프리셋 "${name}" 저장됨`);
    });

    document.getElementById('btnLoadPreset').addEventListener('click', ()=>{
      const sel = document.getElementById('presetSelect');
      const name = sel.value;
      const presets = getPresets();
      if(!name || !presets[name]){ setStatus('presetStatus','불러올 프리셋이 없습니다.', false); return; }
      const p = presets[name];
      applyCounts(p.counts); document.getElementById('extraARS').value = p.extra; document.getElementById('rate').value = p.rate; document.getElementById('note').value = p.note || '';
      calculate();
      setStatus('presetStatus',`프리셋 "${name}" 불러옴`);
    });

    document.getElementById('btnDeletePreset').addEventListener('click', ()=>{
      const name = (document.getElementById('presetName').value || document.getElementById('presetSelect').value || '').trim();
      if(!name){ setStatus('presetStatus','삭제할 프리셋 이름을 선택/입력하세요.', false); return; }
      const presets = getPresets();
      if(!(name in presets)){ setStatus('presetStatus','해당 이름의 프리셋이 없습니다.', false); return; }
      delete presets[name];
      savePresets(presets);
      refreshPresetSelect();
      setStatus('presetStatus',`프리셋 "${name}" 삭제됨`);
    });

    document.getElementById('btnFetchRemote').addEventListener('click', async ()=>{
      const url = (document.getElementById('remoteUrl').value||'').trim();
      if(!url){
        document.getElementById('remoteStatus').textContent = 'URL을 입력하세요.';
        document.getElementById('remoteStatus').style.color = 'var(--danger)';
        return;
      }
      document.getElementById('remoteStatus').textContent = '가져오는 중...';
      document.getElementById('remoteStatus').style.color = '';
      try{
        const { added, names } = await fetchRemotePresets(url);
        document.getElementById('remoteStatus').textContent = `${added}개 추가됨` + (names.length?` — ${names.join(', ')}`:'');
        document.getElementById('remoteStatus').style.color = 'var(--success)';
      } catch(e){
        document.getElementById('remoteStatus').textContent = '가져오기 실패(CORS 또는 페이지 구조 변경)';
        document.getElementById('remoteStatus').style.color = 'var(--danger)';
      }
    });

    // ==== Copy Summary =====
    function buildSummary(obj, mode){
      const lines = [];
      lines.push(`[요약] 총합: ${fmtARS(obj.totalARS)} ARS → ${fmtKRW(obj.totalKRW)} (환율 ${obj.rate}, +₩1,000 포함)`);
      const parts = PACKS.map(v => `${v}×${obj.counts[v]||0}`).join(', ');
      // FIX: 올바른 템플릿 리터럴/삼항 사용 (이전 오류 지점)
      lines.push(`팩: ${parts}${obj.extra ? `, 추가 ${fmtARS(obj.extra)} ARS` : ''}`);
      if(obj.note) lines.push(`메모: ${obj.note}`);

      if(mode==='md'){
        return `**결제 요약**\n\n- **총합**: ${fmtARS(obj.totalARS)} ARS → **${fmtKRW(obj.totalKRW)}** (환율 ${obj.rate}, +₩1,000 포함)\n- **팩**: ${parts}${obj.extra?`\n- **추가**: ${fmtARS(obj.extra)} ARS`:''}${obj.note?`\n- **메모**: ${obj.note}`:''}`;
      }
      if(mode==='discord'){
        return `**결제 요약**\n\n> 총합: **${fmtARS(obj.totalARS)} ARS → ${fmtKRW(obj.totalKRW)}** (환율 ${obj.rate}, +₩1,000 포함)\n> 팩: ${parts}${obj.extra?`\n> 추가: ${fmtARS(obj.extra)} ARS`:''}${obj.note?`\n> 메모: ${obj.note}`:''}`;
      }
      return lines.join('\n');
    }

    document.getElementById('btnCopy').addEventListener('click', async ()=>{
      const obj = toSummaryObj();
      const mode = document.getElementById('formatSelect').value;
      const text = buildSummary(obj, mode);
      try {
        await navigator.clipboard.writeText(text);
        setStatus('copyStatus','클립보드에 복사됨');
      } catch(e){
        setStatus('copyStatus','복사 실패: 브라우저 권한을 확인하세요', false);
      }
    });

    // ==== Theme handling =====
    function setTheme(mode){
      const html = document.documentElement;
      if(mode==='system'){
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        html.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
      } else {
        html.setAttribute('data-theme', mode);
      }
      localStorage.setItem(LS_KEYS.THEME, mode);
      const sel = document.getElementById('themeSelect');
      if(sel && sel.value !== mode) sel.value = mode;
    }

    const themeSelect = document.getElementById('themeSelect');
    if(themeSelect){
      themeSelect.addEventListener('change', (e)=> setTheme(e.target.value));
    }

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', ()=>{
      const mode = localStorage.getItem(LS_KEYS.THEME) || 'system';
      if(mode==='system') setTheme('system');
    });

    // ==== Tests =====
    function runTests(){
      const results = [];
      function ok(cond, msg){ results.push({ ok: !!cond, msg }); if(!cond) console.error('[FAIL]', msg); else console.log('[PASS]', msg); }

      // Test 1: sumARS()
      ok(sumARS({29:1,70:0,142:0,284:0,714:0,1429:0}, 0) === 29, 'sumARS: 29×1 = 29');
      ok(sumARS({29:2,70:1,142:0,284:0,714:0,1429:0}, 5) === 29*2+70+5, 'sumARS: mixed + extra');

      // Test 2: toSummaryObj()
      document.getElementById('pack-29').value = 1;
      document.getElementById('pack-70').value = 0;
      document.getElementById('pack-142').value = 0;
      document.getElementById('pack-284').value = 0;
      document.getElementById('pack-714').value = 0;
      document.getElementById('pack-1429').value = 0;
      document.getElementById('extraARS').value = 0;
      document.getElementById('rate').value = 4;
      const obj = toSummaryObj();
      ok(obj.totalARS === 29, 'toSummaryObj: totalARS correct');
      ok(obj.totalKRW === Math.round(29*4 + 1000), 'toSummaryObj: +1000원 포함 계산');

      // Test 3: Theme set/get (light/dark)
      setTheme('dark');
      ok(document.documentElement.getAttribute('data-theme') === 'dark', 'Theme switch to dark');
      setTheme('light');
      ok(document.documentElement.getAttribute('data-theme') === 'light', 'Theme switch to light');

      // Test 4: Custom theme switch
      setTheme('aurora');
      ok(document.documentElement.getAttribute('data-theme') === 'aurora', 'Theme switch to aurora');

      // Test 5: buildSummary() - extra 포함/미포함 검증
      document.getElementById('extraARS').value = 123;
      const obj2 = toSummaryObj();
      const text = buildSummary(obj2, 'text');
      ok(text.includes('추가') === true, 'buildSummary(text): extra > 0이면 "추가" 포함');
      document.getElementById('extraARS').value = 0;
      const obj3 = toSummaryObj();
      const text2 = buildSummary(obj3, 'text');
      ok(text2.includes('추가') === false, 'buildSummary(text): extra = 0이면 "추가" 미포함');

      const pass = results.every(r=>r.ok);
      setStatus('testStatus', pass ? `모든 테스트 통과 (${results.length}/${results.length})` : `일부 실패 (${results.filter(r=>r.ok).length}/${results.length})`, pass);
    }

    document.getElementById('btnRunTests').addEventListener('click', runTests);

    // ==== Wiring =====
    document.getElementById('btnCalc').addEventListener('click', calculate);
    document.getElementById('btnClear').addEventListener('click', ()=>{
      applyCounts({});
      document.getElementById('extraARS').value = 0;
      document.getElementById('rate').value = 4;
      document.getElementById('note').value = '';
      renderTotals({ totalARS:0, totalKRW:0 });
      setStatus('calcStatus','초기화 완료');
    });

    document.getElementById('btnClearHistory').addEventListener('click', ()=>{
      localStorage.removeItem(LS_KEYS.HISTORY);
      renderHistory();
    });

    // Auto-calc bindings
    document.getElementById('extraARS').addEventListener('input', autoCalc);
    document.getElementById('rate').addEventListener('input', autoCalc);

    // ==== Init =====
    (function init(){
      seedDefaultPresets();
      refreshPresetSelect();
      renderHistory();
      const savedTheme = localStorage.getItem(LS_KEYS.THEME) || 'system';
      setTheme(savedTheme);
      const sel = document.getElementById('themeSelect');
      if(sel) sel.value = savedTheme;
      autoCalc();
      const remote = document.getElementById('remoteUrl');
      if(remote) remote.value = 'https://steampasswordstolez.github.io/AsphaltLegendsMultong/';
    })();
  </script>
</body>
</html>
